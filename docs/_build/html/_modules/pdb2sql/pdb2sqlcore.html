
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>pdb2sql.pdb2sqlcore &#8212; pdb2sql 0.2.2 documentation</title>
    <link rel="stylesheet" href="../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">pdb2sql 0.2.2 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for pdb2sql.pdb2sqlcore</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">subprocess</span> <span class="k">as</span> <span class="nn">sp</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="k">import</span> <span class="n">time</span>

<span class="kn">from</span> <span class="nn">.pdb2sql_base</span> <span class="k">import</span> <span class="n">pdb2sql_base</span>


<span class="k">class</span> <span class="nc">pdb2sql</span><span class="p">(</span><span class="n">pdb2sql_base</span><span class="p">):</span>

<div class="viewcode-block" id="pdb2sql.__init__"><a class="viewcode-back" href="../../pdb2sql.pdb2sqlcore.html#pdb2sql.pdb2sqlcore.pdb2sql.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pdbfile</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">pdbfile</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># create the database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_sql</span><span class="p">()</span>

        <span class="c1"># fix the chain ID</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_chainID</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fix_chainID</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_create_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Create a sql database containg a model PDB.&#39;&#39;&#39;</span>
        <span class="n">pdbfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdbfile</span>
        <span class="n">sqlfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlfile</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-- Create SQLite3 database&#39;</span><span class="p">)</span>

         <span class="c1"># name of the table</span>
        <span class="n">table</span> <span class="o">=</span> <span class="s1">&#39;ATOM&#39;</span>

        <span class="c1"># size of the things</span>
        <span class="n">ncol</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">)</span>
        <span class="n">ndel</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delimiter</span><span class="p">)</span>

        <span class="c1"># open the data base</span>
        <span class="c1"># if we do not specify a db name</span>
        <span class="c1"># the db is only in RAM</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;:memory:&#39;</span><span class="p">)</span>

        <span class="c1"># or we create a new db file</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">sqlfile</span><span class="p">):</span>
                <span class="n">sp</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s1">&#39;rm </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">sqlfile</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">sqlfile</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="c1"># intialize the header/placeholder</span>
        <span class="n">header</span><span class="p">,</span> <span class="n">qm</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">ic</span><span class="p">,</span> <span class="p">(</span><span class="n">colname</span><span class="p">,</span> <span class="n">coltype</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">header</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">{cn}</span><span class="s1"> </span><span class="si">{ct}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cn</span><span class="o">=</span><span class="n">colname</span><span class="p">,</span> <span class="n">ct</span><span class="o">=</span><span class="n">coltype</span><span class="p">)</span>
            <span class="n">qm</span> <span class="o">+=</span> <span class="s1">&#39;?&#39;</span>
            <span class="k">if</span> <span class="n">ic</span> <span class="o">&lt;</span> <span class="n">ncol</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">header</span> <span class="o">+=</span> <span class="s1">&#39;, &#39;</span>
                <span class="n">qm</span> <span class="o">+=</span> <span class="s1">&#39;,&#39;</span>

        <span class="c1"># create the table</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;CREATE TABLE ATOM (</span><span class="si">{hd}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hd</span><span class="o">=</span><span class="n">header</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="c1"># get pdb data</span>
        <span class="n">pdbdata</span> <span class="o">=</span> <span class="n">pdb2sql</span><span class="o">.</span><span class="n">read_pdb</span><span class="p">(</span><span class="n">pdbfile</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nModel</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">data_atom</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">pdbdata</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ATOM&#39;</span><span class="p">):</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ENDMDL&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nModel</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># check pdb line format</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">pdb2sql</span><span class="o">.</span><span class="n">_format_pdb_linelength</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

            <span class="c1"># browse all attribute of each atom</span>
            <span class="n">at</span> <span class="o">=</span> <span class="p">()</span>
            <span class="k">for</span> <span class="n">colname</span><span class="p">,</span> <span class="n">coltype</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

                <span class="c1"># get the piece of data</span>
                <span class="k">if</span> <span class="n">colname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">delimiter</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">delimiter</span><span class="p">[</span><span class="n">colname</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">delimiter</span><span class="p">[</span><span class="n">colname</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

                    <span class="c1"># check pdb format and reset values if necessary</span>
                    <span class="c1"># Empty chainID, occ, temp and element are not allowed</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">colname</span> <span class="o">==</span> <span class="s2">&quot;chainID&quot;</span><span class="p">:</span>
                            <span class="n">data</span> <span class="o">=</span> <span class="n">pdb2sql</span><span class="o">.</span><span class="n">_get_chainID</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">colname</span> <span class="o">==</span> <span class="s2">&quot;occ&quot;</span><span class="p">:</span>
                            <span class="n">data</span> <span class="o">=</span> <span class="mf">1.00</span>
                        <span class="k">if</span> <span class="n">colname</span> <span class="o">==</span> <span class="s2">&quot;temp&quot;</span><span class="p">:</span>
                            <span class="n">data</span> <span class="o">=</span> <span class="mf">10.00</span>
                        <span class="k">if</span> <span class="n">colname</span> <span class="o">==</span> <span class="s2">&quot;element&quot;</span><span class="p">:</span>
                            <span class="n">data</span> <span class="o">=</span> <span class="n">pdb2sql</span><span class="o">.</span><span class="n">_get_element</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

                    <span class="c1"># convert it if necessary</span>
                    <span class="k">if</span> <span class="n">coltype</span> <span class="o">==</span> <span class="s1">&#39;INT&#39;</span><span class="p">:</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">coltype</span> <span class="o">==</span> <span class="s1">&#39;REAL&#39;</span><span class="p">:</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

                    <span class="c1"># append keep the comma !!</span>
                    <span class="c1"># we need proper tuple</span>
                    <span class="n">at</span> <span class="o">+=</span> <span class="p">(</span><span class="n">data</span><span class="p">,)</span>

            <span class="c1"># append the model number</span>
            <span class="n">at</span> <span class="o">+=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nModel</span><span class="p">,)</span>

            <span class="c1"># append</span>
            <span class="n">data_atom</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">at</span><span class="p">)</span>

        <span class="c1"># push in the database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span>
            <span class="s1">&#39;INSERT INTO ATOM VALUES (</span><span class="si">{qm}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">qm</span><span class="o">=</span><span class="n">qm</span><span class="p">),</span> <span class="n">data_atom</span><span class="p">)</span>

<div class="viewcode-block" id="pdb2sql.read_pdb"><a class="viewcode-back" href="../../api/pdb2sql.pdb2sqlcore.pdb2sql.read_pdb.html#pdb2sql.pdb2sqlcore.pdb2sql.read_pdb">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">read_pdb</span><span class="p">(</span><span class="n">pdbfile</span><span class="p">):</span>
        <span class="c1"># read the pdb file a pure python way</span>
        <span class="c1"># RMK we go through the data twice here. Once to read the ATOM line and once to parse the data ...</span>
        <span class="c1"># we could do better than that. But the most time consuming step seems</span>
        <span class="c1"># to be the CREATE TABLE query</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pdbfile</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">pdbfile</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pdbfile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fi</span><span class="p">:</span>
                    <span class="n">pdbdata</span> <span class="o">=</span> <span class="n">fi</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;PDB file </span><span class="si">{pdbfile}</span><span class="s1"> not found&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pdbfile</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pdbfile</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">pdbdata</span> <span class="o">=</span> <span class="n">pdbfile</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pdbfile</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">bytes</span><span class="p">):</span>
                <span class="n">pdbdata</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">pdbfile</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Non-valid pdb input </span><span class="si">{pdbfile}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pdbfile</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">pdbfile</span> <span class="o">=</span> <span class="n">pdbfile</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pdbfile</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">pdbdata</span> <span class="o">=</span> <span class="n">pdbfile</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pdbfile</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">bytes</span><span class="p">):</span>
                <span class="n">pdbdata</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">pdbfile</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Non-valid pdb input </span><span class="si">{pdbfile}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Non-valid pdb input: </span><span class="si">{pdbfile}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pdbdata</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_format_pdb_linelength</span><span class="p">(</span><span class="n">pdb_line</span><span class="p">):</span>
        <span class="n">linelen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pdb_line</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">linelen</span> <span class="o">&lt;</span> <span class="mi">80</span><span class="p">:</span>
            <span class="n">pdb_line</span> <span class="o">=</span> <span class="n">pdb_line</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">80</span> <span class="o">-</span> <span class="n">linelen</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">linelen</span> <span class="o">&gt;</span> <span class="mi">80</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;pdb line is longer than 80:</span><span class="se">\n</span><span class="si">{pdb_line}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pdb_line</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_chainID</span><span class="p">(</span><span class="n">pdb_line</span><span class="p">):</span>
        <span class="n">segID_ind</span> <span class="o">=</span> <span class="p">[</span><span class="mi">72</span><span class="p">,</span> <span class="mi">76</span><span class="p">]</span>    <span class="c1"># segID columns in pdb</span>
        <span class="n">segID</span> <span class="o">=</span> <span class="n">pdb_line</span><span class="p">[</span><span class="n">segID_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">segID_ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">segID</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Missing chainID and set it with segID&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">segID</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;chainID not found&#39;</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_element</span><span class="p">(</span><span class="n">pdb_line</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get element type from the atom type of a pdb line</span>

<span class="sd">        Notes:</span>
<span class="sd">            Atom type occupies 13-16th columns of a PDB line.</span>
<span class="sd">            http://www.wwpdb.org/documentation/file-format-content/format33/sect9.html#ATOM</span>
<span class="sd">            Four situations exist:</span>
<span class="sd">                13 14 15 16</span>
<span class="sd">                   C  A      The element is C</span>
<span class="sd">                C  A         The element is Ca</span>
<span class="sd">                1  H  G      The element is H</span>
<span class="sd">                H  E  2  1   The element is H</span>

<span class="sd">        Args:</span>
<span class="sd">            pdb_line(str): one PDB ATOM line</span>

<span class="sd">        Returns:</span>
<span class="sd">            [str]: element name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">first_char</span> <span class="o">=</span> <span class="n">pdb_line</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">last_char</span> <span class="o">=</span> <span class="n">pdb_line</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">first_char</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">first_char</span> <span class="ow">in</span> <span class="s2">&quot;0123456789&quot;</span><span class="p">:</span>
                <span class="n">elem</span> <span class="o">=</span> <span class="n">pdb_line</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">first_char</span> <span class="o">==</span> <span class="s2">&quot;H&quot;</span> <span class="ow">and</span> <span class="n">last_char</span><span class="p">:</span>
                <span class="n">elem</span> <span class="o">=</span> <span class="s2">&quot;H&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">elem</span> <span class="o">=</span> <span class="n">pdb_line</span><span class="p">[</span><span class="mi">12</span><span class="p">:</span><span class="mi">14</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">elem</span> <span class="o">=</span> <span class="n">pdb_line</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Missing element and guess it with atom type&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">elem</span>

    <span class="c1"># replace the chain ID by A,B,C,D, ..... in that order</span>
    <span class="k">def</span> <span class="nf">_fix_chainID</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="kn">from</span> <span class="nn">string</span> <span class="k">import</span> <span class="n">ascii_uppercase</span>

        <span class="c1"># get the current names</span>
        <span class="n">chainID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;chainID&#39;</span><span class="p">)</span>
        <span class="n">natom</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chainID</span><span class="p">)</span>
        <span class="n">chainID</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">chainID</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chainID</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">26</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;More than 26 chains have been detected, not supported so far&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># declare the new names</span>
        <span class="n">newID</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">natom</span>

        <span class="c1"># fill in the new names</span>
        <span class="k">for</span> <span class="n">ic</span><span class="p">,</span> <span class="n">chain</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">chainID</span><span class="p">):</span>
            <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rowID&#39;</span><span class="p">,</span> <span class="n">chainID</span><span class="o">=</span><span class="n">chain</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">index</span><span class="p">:</span>
                <span class="n">newID</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">ascii_uppercase</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span>

        <span class="c1"># update the new name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_column</span><span class="p">(</span><span class="s1">&#39;chainID&#39;</span><span class="p">,</span> <span class="n">newID</span><span class="p">)</span>

    <span class="c1"># get the names of the columns</span>

<div class="viewcode-block" id="pdb2sql.get_colnames"><a class="viewcode-back" href="../../api/pdb2sql.pdb2sqlcore.pdb2sql.get_colnames.html#pdb2sql.pdb2sqlcore.pdb2sql.get_colnames">[docs]</a>    <span class="k">def</span> <span class="nf">get_colnames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;select * from atom&#39;</span><span class="p">)</span>
        <span class="n">names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cd</span><span class="o">.</span><span class="n">description</span><span class="p">))</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;rowID&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">names</span>
        <span class="k">return</span> <span class="n">names</span></div>

<div class="viewcode-block" id="pdb2sql.print_colnames"><a class="viewcode-back" href="../../api/pdb2sql.pdb2sqlcore.pdb2sql.print_colnames.html#pdb2sql.pdb2sqlcore.pdb2sql.print_colnames">[docs]</a>    <span class="k">def</span> <span class="nf">print_colnames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_colnames</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Possible column names are:&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">n</span><span class="p">)</span></div>

    <span class="c1"># print the database</span>
<div class="viewcode-block" id="pdb2sql.pprint"><a class="viewcode-back" href="../../api/pdb2sql.pdb2sqlcore.pdb2sql.pprint.html#pdb2sql.pdb2sqlcore.pdb2sql.pprint">[docs]</a>    <span class="k">def</span> <span class="nf">pprint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">pandas.io.sql</span> <span class="k">as</span> <span class="nn">psql</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">psql</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM ATOM&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></div>

<div class="viewcode-block" id="pdb2sql.print"><a class="viewcode-back" href="../../api/pdb2sql.pdb2sqlcore.pdb2sql.print.html#pdb2sql.pdb2sqlcore.pdb2sql.print">[docs]</a>    <span class="k">def</span> <span class="nf">print</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ctmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">ctmp</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM ATOM&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">ctmp</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span></div>

    <span class="c1"># get the properties</span>
<div class="viewcode-block" id="pdb2sql.get"><a class="viewcode-back" href="../../api/pdb2sql.pdb2sqlcore.pdb2sql.get.html#pdb2sql.pdb2sqlcore.pdb2sql.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Exectute simple SQL query to extract values of attributes</span>
<span class="sd">            for certain conditions.</span>

<span class="sd">        Args :</span>
<span class="sd">            columns (str): columns to retreive, eg: &quot;x,y,z&quot;.</span>
<span class="sd">                if &quot;*&quot; all the columns are returned.</span>
<span class="sd">                Check all available columns by print_colnames().</span>
<span class="sd">            kwargs: argument to select atoms, dict value must be list.</span>
<span class="sd">                eg: name = [&#39;CA&#39;, &#39;O&#39;], chainID = [&#39;A&#39;],</span>
<span class="sd">                or no_name = [&#39;CA&#39;, &#39;C&#39;], no_chainID = [&#39;A&#39;].</span>

<span class="sd">        Returns:</span>
<span class="sd">            data: list containing the value of the attributes</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; db.get(&#39;x,y,z&#39;, chainID=[&#39;A&#39;], no_resName=[&#39;ALA&#39;, &#39;TRP&#39;])</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># check arguments format</span>
        <span class="n">valid_colnames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_colnames</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;argument columns must be str&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">columns</span> <span class="o">!=</span> <span class="s1">&#39;*&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">columns</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_colnames</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="n">f</span><span class="s1">&#39;Invalid column name </span><span class="si">{i}</span><span class="s1">. Possible names are</span><span class="se">\n</span><span class="s1">&#39;</span>
                        <span class="n">f</span><span class="s1">&#39;{self.get_colnames()}&#39;</span><span class="p">)</span>

        <span class="c1"># the asked keys</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

        <span class="k">if</span> <span class="s1">&#39;model&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">nModel</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">model_data</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">iModel</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nModel</span><span class="p">):</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iModel</span>
                <span class="n">model_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">model_data</span>

        <span class="c1"># if we have 0 key we take the entire db</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;SELECT </span><span class="si">{an}</span><span class="s1"> FROM ATOM&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">an</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)]</span>

        <span class="c1">#######################################################################</span>
        <span class="c1"># GENERIC QUERY</span>
        <span class="c1">#</span>
        <span class="c1"># each keys must be a valid columns</span>
        <span class="c1"># each valu may be a single value or an array</span>
        <span class="c1"># AND is assumed between different keys</span>
        <span class="c1"># OR is assumed for the different values of a given key</span>
        <span class="c1">#</span>
        <span class="c1">#######################################################################</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># check that all the keys exists</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;no_&#39;</span><span class="p">):</span>
                    <span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                        <span class="s2">&quot;SELECT EXISTS(SELECT </span><span class="si">{an}</span><span class="s2"> FROM ATOM)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">an</span><span class="o">=</span><span class="n">k</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="n">f</span><span class="s1">&#39;Invalid column name </span><span class="si">{k}</span><span class="s1">. Possible names are</span><span class="se">\n</span><span class="s1">&#39;</span>
                        <span class="n">f</span><span class="s1">&#39;{self.get_colnames()}&#39;</span><span class="p">)</span>

            <span class="c1"># form the query and the tuple value</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;SELECT </span><span class="si">{an}</span><span class="s1"> FROM ATOM WHERE &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">an</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>
            <span class="n">conditions</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="p">()</span>

            <span class="c1"># iterate through the kwargs</span>
            <span class="k">for</span> <span class="n">ik</span><span class="p">,</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>

                <span class="c1"># deals with negative conditions</span>
                <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;no_&#39;</span><span class="p">):</span>
                    <span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>
                    <span class="n">neg</span> <span class="o">=</span> <span class="s1">&#39; NOT&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">neg</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

                <span class="c1"># get if we have an array or a scalar</span>
                <span class="c1"># and build the value tuple for the sql query</span>
                <span class="c1"># deal with the indexing issue if rowID is required</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">nv</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

                    <span class="c1"># if we have a large number of values</span>
                    <span class="c1"># we must cut that in pieces because SQL has a hard limit</span>
                    <span class="c1"># that is 999. The limit is here set to 950</span>
                    <span class="c1"># so that we can have multiple conditions with a total number</span>
                    <span class="c1"># of values inferior to 999</span>
                    <span class="k">if</span> <span class="n">nv</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_sql_values</span><span class="p">:</span>

                        <span class="c1"># cut in chunck</span>
                        <span class="n">chunck_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_sql_values</span>
                        <span class="n">vchunck</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">chunck_size</span><span class="p">]</span>
                                   <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nv</span><span class="p">,</span> <span class="n">chunck_size</span><span class="p">)]</span>

                        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vchunck</span><span class="p">:</span>
                            <span class="n">new_kwargs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                            <span class="n">new_kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
                            <span class="n">data</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="o">**</span><span class="n">new_kwargs</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">data</span>

                    <span class="c1"># otherwise we just go on</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;rowID&#39;</span><span class="p">:</span>
                            <span class="n">vals</span> <span class="o">=</span> <span class="n">vals</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">iv</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">iv</span> <span class="ow">in</span> <span class="n">v</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">vals</span> <span class="o">=</span> <span class="n">vals</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">nv</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;rowID&#39;</span><span class="p">:</span>
                        <span class="n">vals</span> <span class="o">=</span> <span class="n">vals</span> <span class="o">+</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">vals</span> <span class="o">=</span> <span class="n">vals</span> <span class="o">+</span> <span class="p">(</span><span class="n">v</span><span class="p">,)</span>

                <span class="c1"># create the condition for that key</span>
                <span class="n">conditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="n">neg</span> <span class="o">+</span> <span class="s1">&#39; in (&#39;</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;?&#39;</span> <span class="o">*</span> <span class="n">nv</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">)</span>

            <span class="c1"># stitch the conditions and append to the query</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s1">&#39; AND &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">conditions</span><span class="p">)</span>

            <span class="c1"># error if vals is too long</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">SQLITE_LIMIT_VARIABLE_NUMBER</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Error : SQL Queries can only handle a total of 999 values&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;      : The current query has </span><span class="si">%d</span><span class="s1"> values&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;      : Hence it will fails.&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s1">&#39;      : You are in a rare situation where MULTIPLE conditions have&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;      : have a combined number of values that are too large&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;      : These conditions are:&#39;</span><span class="p">)</span>
                <span class="n">ntot</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;      : --&gt; </span><span class="si">%10s</span><span class="s1"> : </span><span class="si">%d</span><span class="s1"> values&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)))</span>
                    <span class="n">ntot</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;      : --&gt; </span><span class="si">%10s</span><span class="s1"> : </span><span class="si">%d</span><span class="s1"> values&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;Total&#39;</span><span class="p">,</span> <span class="n">ntot</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;      : Try to decrease max_sql_values in pdb2sql.py</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Too many SQL variables&#39;</span><span class="p">)</span>

            <span class="c1"># query the sql database and return the answer in a list</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">vals</span><span class="p">)]</span>

        <span class="c1"># empty data</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;SQL query get an empty&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">data</span>

        <span class="c1"># fix the python &lt;--&gt; sql indexes</span>
        <span class="c1"># if atnames == &#39;rowID&#39;:</span>
        <span class="k">if</span> <span class="s1">&#39;rowID&#39;</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">columns</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;rowID&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
                <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="c1"># postporcess the output of the SQl query</span>
        <span class="c1"># flatten it if each els is of size 1</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">data</span></div>

<div class="viewcode-block" id="pdb2sql.update"><a class="viewcode-back" href="../../api/pdb2sql.pdb2sqlcore.pdb2sql.update.html#pdb2sql.pdb2sqlcore.pdb2sql.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Update the database.</span>

<span class="sd">        Args:</span>
<span class="sd">            columns (str): names of column to update, e.g. &quot;x,y,z&quot;.</span>
<span class="sd">            values (np.ndarray): an array of values that corresponds</span>
<span class="sd">                        to the number of columns and atoms selected.</span>
<span class="sd">            **kwargs: selection arguments,</span>
<span class="sd">                eg: name = [&#39;CA&#39;, &#39;O&#39;], chainID = [&#39;A&#39;],</span>
<span class="sd">                or no_name = [&#39;CA&#39;, &#39;C&#39;], no_chainID = [&#39;A&#39;].</span>
<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; values = np.array([[1.,2.,3.], [4.,5.,6.]])</span>
<span class="sd">            &gt;&gt;&gt; self.db.update(&quot;x,y,z&quot;, values=values, resName=&#39;MET&#39;, name=[&#39;CA&#39;, &#39;CB&#39;])</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># check arguments format</span>
        <span class="n">valid_colnames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_colnames</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;argument columns must be str&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">columns</span> <span class="o">!=</span> <span class="s1">&#39;*&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">columns</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_colnames</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="n">f</span><span class="s1">&#39;Invalid column name </span><span class="si">{i}</span><span class="s1">. Possible names are</span><span class="se">\n</span><span class="s1">&#39;</span>
                        <span class="n">f</span><span class="s1">&#39;{self.get_colnames()}&#39;</span><span class="p">)</span>

        <span class="c1"># the asked keys</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

        <span class="c1"># handle the multi model cases</span>
        <span class="k">if</span> <span class="s1">&#39;model&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keys</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">nModel</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">iModel</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nModel</span><span class="p">):</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iModel</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># parse the attribute</span>
        <span class="k">if</span> <span class="s1">&#39;,&#39;</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="n">columns</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">columns</span><span class="p">]</span>

        <span class="c1"># check the size</span>
        <span class="n">natt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">nrow</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="n">ncol</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">natt</span> <span class="o">!=</span> <span class="n">ncol</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Number of cloumns does not match between argument columns and values&#39;</span><span class="p">)</span>

        <span class="c1"># get the row ID of the selection</span>
        <span class="n">rowID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rowID&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">nselect</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rowID</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">nselect</span> <span class="o">!=</span> <span class="n">nrow</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Number of data values incompatible with the given conditions&#39;</span><span class="p">)</span>

        <span class="c1"># prepare the query</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;UPDATE ATOM SET &#39;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">query</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="s1">&#39;=?&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="p">))</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">query</span> <span class="o">+</span> <span class="s1">&#39; WHERE rowID=?&#39;</span>

        <span class="c1"># prepare the data</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>

            <span class="n">tmp_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">val</span><span class="p">]</span>

            <span class="c1"># here the conversion of the indexes is a bit annoying</span>
            <span class="n">tmp_data</span> <span class="o">+=</span> <span class="p">[</span><span class="n">rowID</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp_data</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span></div>

<div class="viewcode-block" id="pdb2sql.update_column"><a class="viewcode-back" href="../../api/pdb2sql.pdb2sqlcore.pdb2sql.update_column.html#pdb2sql.pdb2sqlcore.pdb2sql.update_column">[docs]</a>    <span class="k">def</span> <span class="nf">update_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colname</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Update a single column.</span>

<span class="sd">        Args:</span>
<span class="sd">            colname (str): name of the column to update</span>
<span class="sd">            values (list): new values of the column</span>
<span class="sd">            index (None, optional): index of the column to update (default all)</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; db.update_column(&#39;x&#39;,np.random.rand(10),index=list(range(10)))</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[[</span><span class="n">v</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">values</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[[</span><span class="n">v</span><span class="p">,</span> <span class="n">ind</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">index</span><span class="p">)]</span>

        <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;UPDATE ATOM SET </span><span class="si">{cn}</span><span class="s1">=? WHERE rowID=?&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cn</span><span class="o">=</span><span class="n">colname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span></div>

<div class="viewcode-block" id="pdb2sql.add_column"><a class="viewcode-back" href="../../api/pdb2sql.pdb2sqlcore.pdb2sql.add_column.html#pdb2sql.pdb2sqlcore.pdb2sql.add_column">[docs]</a>    <span class="k">def</span> <span class="nf">add_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colname</span><span class="p">,</span> <span class="n">coltype</span><span class="o">=</span><span class="s1">&#39;FLOAT&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add an extra column to the ATOM table with same value for each row.</span>

<span class="sd">        Args:</span>
<span class="sd">            colname (str): the new column name</span>
<span class="sd">            coltype (str): data type of the new column. Default to float.</span>
<span class="sd">            value (int/float/str): value for the new column.</span>
<span class="sd">                Default to 0.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; add_column(&#39;id&#39;, coltype=&#39;str&#39;, value=&#39;positive&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;ALTER TABLE ATOM ADD COLUMN &#39;</span><span class="si">%s</span><span class="s2">&#39; </span><span class="si">%s</span><span class="s2"> DEFAULT </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">colname</span><span class="p">,</span> <span class="n">coltype</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">commit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Cpmmit to the database.&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">pdb2sql 0.2.2 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2019, Netherlands eScience Center.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.1.2.
    </div>
  </body>
</html>